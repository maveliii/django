<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO List</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa; /* Light grey background */
            font-family: Arial, sans-serif;
        }
        .thick {
            font-weight: bold;
            color: red;
        }
        .thick2 {
            font-weight: bold;
            text-align: center;
        }     
        .container {
            margin-top: 50px;
        }
        h1 {
            color: #343a40; /* Dark grey */
        }
        .filter-bar {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            background-color: white;
            padding: 10px;
            border: 2px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        #action-id{
            display:none;
        }
        .action-main {
            display: flex;
            background-color: white;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .mainhome {
            display: flex;
        }
        .home-button {
            background-color: goldenrod;
            padding-right: 20px;
            padding-left: 20px;
            display: block;
            width: 100px;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-align: center;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .filter-bar input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .filter-bar label {
            margin-right: 10px;
        }
        .selected {
            background-color: #000; /* Darker background for selected rows */
        }
        .action-buttons {
            display: flex;
            width: 70%; /* Hidden by default */
        }
        .action-buttons .btn {
            margin-right: 10px;
        }
        .comment-box {
            margin-top: 10px;
        }
        .comment-box textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .assign-user-form {
            margin-left: 470px;
            align-items:end;
            justify-content: left;
            display: flex;
            width:50%;
            
             /* Hidden by default */
        }
        .table-container {
            height:80%; /* Adjust this height as needed */
            overflow-y: auto;
            border: 1px solid #ddd; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);/* Optional: Adds a border around the table container */
        }
        .confirm-button {
            margin-left: 10px;
            background-color: green;
        }
        .text-main {
            align-items: center;
            position:relative;
            width:85%;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mainhome">
            {% if role == 'user'%}
                <a href="{% url 'userhome' username %}" class="home-button mb-4 "><div>Home</div></a>
            {% endif %}    
            {% if role == 'qa'%}
                <a href="{% url 'qahome' username %}" class="home-button mb-4 "><div>Home</div></a>
            {% endif %}  
            <h1 class="text-main mb-4">Purchase Orders</h1>
        </div>
        <h2 class="text-center mb-4">VendorName: {{vendorname}}</h2>
        <!-- Filter Bar -->
        <div class="filter-bar">
            <!-- Search Input -->
            <input type="text" id="search-input" placeholder="Search PO number...">
            <!-- Checkbox Filters -->
            <div class="checkbox-group mt-2">
                <input type="checkbox" id="no-proposed-date">
                <label for="no-proposed-date">Inspection Date Not Yet Proposed</label>
                <input type="checkbox" id="proposed-but-no-inspection">
                <label for="proposed-but-no-inspection">Inspection Date to be Approved</label>
            </div>
        </div>
        {% if role == 'user' %}
        <span class="action-main " id="action-id">
            <!-- Action Buttons -->
            <div class="action-buttons">
                <form id="approve-form" action="{% url 'approve_inspection' vendorno username %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="selected_ponos" id="selected_ponos_hidden">
                    <button type="submit" class="btn btn-success ">Approve Selected</button>
                </form>
                <!-- Reject Button triggers Modal -->
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
                    Reject Selected
                </button>
            </div>
            <!-- Assign User Form -->
            <div class="assign-user-form">
                <form action="{% url 'assignuser' username %}" method="post">
                    {% csrf_token %}
                    <select name="assign_user" id="assign_user">
                        <option value="Assign User">Assign User</option>
                        {% for user in users %}
                            {% if user.role == 'qa' %}
                                <option value="{{ user.username }}">{{ user.username }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <input type="hidden" name="selected_ponos" id="selected_ponos">
                    <button type="submit" class="btn btn-success ">Assign Selected</button>
                </form>
            </div>
        </span>
        {% endif %}
        
        <!-- Table -->
        <div class="table-container">
            <table class="table table-striped table-bordered" id="po-table">
                <thead class="thead-dark">
                    <tr>
                        {% if role == 'user'%}
                            <th scope="col"><input type="checkbox" id="select-all"></th>
                        {% endif %}
                        
                        <th scope="col">PONO</th>
                        <th scope="col">Customer</th>
                        <th scope="col">Delivery Date</th>
                        <th scope="col">Inspection Date Submission</th>
                        <th scope="col">Inspection Date</th>
                        <th scope="col">Inspection Date Proposed</th>
                        {% if role == 'user'%}
                            <th scope="col">Actions</th>
                        {% endif %}  
                        <th scope="col">Status</th>
                        <th scope="col">Assigned user</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loop through purchase orders -->
                    {% for purchase in purchase %}
                        <tr class="purchase-row"
                            data-pono="{{ purchase.pono }}"
                            data-inspectiondateproposed="{% if purchase.inspectiondateproposed %}{{ purchase.inspectiondateproposed }}{% else %}None{% endif %}"
                            data-inspectiondate="{% if purchase.inspectiondate %}{{ purchase.inspectiondate }}{% else %}None{% endif %}">
                            {% if role == 'user'%}
                                <td><input type="checkbox" class="select-po" value="{{ purchase.pono }}"></td>
                            {% endif %}  
                            <td>{{ purchase.pono }}</td>
                            <td>{{ purchase.customer }}</td>
                            <td>{{ purchase.shipdate }}</td>
                            <td>{{ purchase.iasubmissiondate }}</td>
                            <td>{% if purchase.inspectiondate %}{{ purchase.inspectiondate }}{% else %}Not Provided{% endif %}</td>
                            <td>{% if purchase.inspectiondateproposed %}{{ purchase.inspectiondateproposed }}{% else %}Not Proposed{% endif %}</td>
                            {% if role == 'user' %}
                                <td class="bold">
                                    <!-- Conditional action buttons -->
                                    {% if purchase.inspectiondateproposed and not purchase.inspectiondate %}
                                        <div class="thick">
                                            Select to Approve/Reject
                                        </div>
                                    {% else %}
                                        <div >No action Required</div>
                                    {% endif %}
                                </td>
                            {% endif %}
                            <td>{{ purchase.status }}</td>
                            <td>{{ purchase.username_id }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Reject Selected Purchase Orders</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reject-form" action="{% url 'reject_inspection' vendorno username %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="selected_ponos" id="selected_ponos_hidden_reject_modal">
                        <div class="comment-box">
                            <textarea name="reject_reason" id="reject_reason" placeholder="Enter rejection reason..." rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger mt-3">Reject</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const selectAllCheckbox = document.getElementById('select-all');
            const poCheckboxes = document.querySelectorAll('.select-po');
            const selectedPonosHidden = document.getElementById('selected_ponos_hidden');
            const selectedPonosHiddenRejectModal = document.getElementById('selected_ponos_hidden_reject_modal');
            const actionMain = document.getElementById('action-id');
            const selectedPonosAssignUser = document.getElementById('selected_ponos');
            const searchInput = document.getElementById('search-input');
            const noProposedDateCheckbox = document.getElementById('no-proposed-date');
            const proposedButNoInspectionCheckbox = document.getElementById('proposed-but-no-inspection');

            function updateSelectedPonos() {
                const selectedPonos = Array.from(poCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);
                selectedPonosHidden.value = JSON.stringify(selectedPonos);
                selectedPonosHiddenRejectModal.value = JSON.stringify(selectedPonos);
                selectedPonosAssignUser.value = JSON.stringify(selectedPonos);

                // Show or hide action buttons based on selection
                if (selectedPonos.length > 0) {
                    actionMain.style.display = 'flex';
                } else {
                    actionMain.style.display = 'none';
                }
            }

            selectAllCheckbox.addEventListener('change', function() {
                poCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                    if (selectAllCheckbox.checked) {
                        checkbox.closest('tr').classList.add('selected');
                    } else {
                        checkbox.closest('tr').classList.remove('selected');
                    }
                });
                updateSelectedPonos();
            });

            poCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (checkbox.checked) {
                        checkbox.closest('tr').classList.add('selected');
                    } else {
                        checkbox.closest('tr').classList.remove('selected');
                    }
                    updateSelectedPonos();
                });
            });

            function filterTable() {
                const searchValue = searchInput.value.toLowerCase();
                const noProposedDateChecked = noProposedDateCheckbox.checked;
                const proposedButNoInspectionChecked = proposedButNoInspectionCheckbox.checked;

                document.querySelectorAll('.purchase-row').forEach(row => {
                    const pono = row.dataset.pono.toLowerCase();
                    const inspectionDateProposed = row.dataset.inspectiondateproposed.toLowerCase();
                    const inspectionDate = row.dataset.inspectiondate.toLowerCase();

                    let matchesSearch = pono.includes(searchValue);
                    let matchesFilters = true;

                    if (noProposedDateChecked && inspectionDateProposed !== 'none') {
                        matchesFilters = false;
                    }

                    if (proposedButNoInspectionChecked && (inspectionDateProposed === 'none' || inspectionDate !== 'none')) {
                        matchesFilters = false;
                    }

                    if (matchesSearch && matchesFilters) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filterTable);
            noProposedDateCheckbox.addEventListener('change', filterTable);
            proposedButNoInspectionCheckbox.addEventListener('change', filterTable);
        });
    </script>
</body>
</html>
